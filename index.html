<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">

    <head>
        <title>Python Play</title>
        <link href="node_modules/codemirror/lib/codemirror.css" rel="stylesheet">
        <link href="node_modules/codemirror/theme/mdn-like.css" rel="stylesheet">
        <link href="node_modules/codemirror/theme/xq-light.css" rel="stylesheet">
        <link href="node_modules/codemirror/theme/neat.css" rel="stylesheet">
        <link href="custom-play.css" rel="stylesheet">
        <style type="text/css">
            html, body {
                margin: 0;
                padding: 0;
                font-size: 13px;
                font-family: Helvetica, Arial, sans-serif;
                line-height: 1;
            }
            body {
                display: flex;
            }
            table {
                border-collapse: collapse;
                border-spacing: none;
            }
            p {
                margin: 0;
            }

            #commands h1 {
                font-size: 14px;
                cursor: pointer;
                text-decoration: none;
                margin: 18px 0 8px 0;
            }
            #commands h1:hover {
                text-decoration: underline;
            }
            #commands a {
                font-family: monospace;
                display: block;
                color: black;
                margin-left: 8px;
                padding: 4px 2px;
                text-decoration: none;
            }
            #commands a:hover {
                background-color: #ccc;
            }
            #output {
                color: white;
                padding: 10px;
                line-height: 1.2;
                background-color: black;
                font-family: monospace;
            }
            #output pre {
              /*white-space: normal;*/
            }
            #output br {
                line-height: 2.5;
            }
            .CodeMirror {
                height: 94vh;
            }

            #commands b {
                display: block;
                margin-left: 10px;
                margin-top: 15px;
            }
        </style>
        <!-- <link href="" rel="stylesheet"> -->

        <!--
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@glenchsite" />
        <meta name="twitter:creator" content="@glench" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="http://glench.com/DeepListeningAtTheRecurseCenter/" />
        <meta property="og:title" content="Deep Listening at the Recurse Center" />
        <meta property="og:description" content="Helping programmers become more self-directed through meditative listening." />
        <meta property="og:image" content="http://glench.com/DeepListeningAtTheRecurseCenter/icon.png" />
        -->

    </head>
    <body>

        <div id="commands" style="margin-top: 32px; padding-left: 3px; height: 94vh; overflow: auto; width:195px;">
            <div><input id="start-program-option" type="checkbox" checked="checked"> <label for="start-program-option">Start program when command clicked?</label></div>
            <div>
                <h1>New Sprite -</h1>
                <a href="#null" command="image = play.new_image(image=None, x=0, y=0, size=100, angle=0, transparency=100)">new_image()</a>
                <a href="#null" command="text = play.new_text(words='hi :)', x=0, y=0, font=None, font_size=50, color='black', angle=0, transparency=100)">new_text()</a>
                <a href="#null" command="box = play.new_box(color='black', x=0, y=0, width=100, height=200, border_color='light blue', border_width=0, angle=0, transparency=100, size=100)">new_box()</a>
                <a href="#null" command="circle = play.new_circle(color='black', x=0, y=0, radius=100, border_color='light blue', border_width=0, transparency=100, size=100, angle=0)">new_circle()</a>
                <a href="#null" command="line = play.new_line(color='black', x=0, y=0, length=None, angle=None, thickness=1, x1=None, y1=None, transparency=100, size=100)">new_line()</a>
            </div>
            <div>
                <h1>Sprite Commands -</h1>
                <a href="#null" command="${sprite}.move(100)">move(100)</a>
                <a href="#null" command="${sprite}.turn(45)">turn(45)</a>
                <a href="#null" command="${sprite}.go_to(play.mouse)">go_to(position)</a>
                <a href="#null" command="${sprite}.go_to(x=0, y=0)">go_to(x=0, y=0)</a>
                <a href="#null" command="${sprite}.point_towards(play.mouse)">point_towards(position)</a>
                <a href="#null" command="${sprite}.hide()">hide()</a>
                <a href="#null" command="${sprite}.show()">show()</a>
                <a href="#null" command="clone = ${sprite}.clone()">clone()</a>
                <a href="#null" command="${sprite}.remove()">remove()</a>
            </div>
            <div>
                <h1>Control -</h1>
                <a href="#null" command="@play.repeat_forever
async def do():
    print('repeating forever!')">@repeat_forever</a>
                <a href="#null" command="@play.when_program_starts
async def do():
    print('this runs just when the program starts!')">@when_program_starts</a>
                <a href="#null" command="for count in play.repeat(10):
    print(count)">repeat 10 times</a>
            </div>

            <div id="sprite-info">
                <h1>Sprite Info -</h1>
                <a href="#null" command="${sprite}.x = 100">sprite.x</a>
                <a href="#null" command="${sprite}.y = 100">sprite.y</a>
                <a href="#null" command="${sprite}.angle = 45">sprite.angle</a>
                <a href="#null" command="${sprite}.transparency = 50">sprite.transparency</a>
                <a href="#null" command="${sprite}.size = 300">sprite.size</a>
                <a href="#null" command="${sprite}.is_hidden = True">sprite.is_hidden</a>
                <a href="#null" command="${sprite}.is_shown = False">sprite.is_shown</a>
                <a href="#null" command="${sprite}.left = -200">sprite.left</a>
                <a href="#null" command="${sprite}.right = 200">sprite.right</a>
                <a href="#null" command="${sprite}.top = 200">sprite.top</a>
                <a href="#null" command="${sprite}.bottom = -200">sprite.bottom</a>

                <b>Other info</b>
                <a href="#null" command="${sprite}.width">sprite.width</a>
                <a href="#null" command="${sprite}.height">sprite.height</a>
                <a href="#null" command="print(${sprite}.distance_to(play.mouse))">sprite.distance_to(other)</a>
                <a href="#null" command="print(${sprite}.distance_to(x=100, y=100))">sprite.distance_to(x=100,y=100)</a>
                <a href="#null" command="if ${sprite}.is_clicked:
    ${sprite}.turn(30)">sprite.is_clicked</a>
                <a href="#null" command="if ${sprite}.is_touching(play.mouse):
    ${sprite}.turn(30)">sprite.is_touching(play.mouse)</a>

                <b>Image sprites</b>
                <a href="#null" command="${sprite}.image">sprite.image</a>

                <b>Text sprites</b>
                <a href="#null" command="${sprite}.words = 'hiya'">sprite.words</a>
                <a href="#null" command="${sprite}.font = 'Arial.ttf'">sprite.font</a>
                <a href="#null" command="${sprite}.font_size = '40">sprite.font_size</a>
                <a href="#null" command="${sprite}.color = 'red'">sprite.color</a>

                <b>Box sprites</b>
                <a href="#null" command="${sprite}.color = 'dark blue'">sprite.color</a>
                <a href="#null" command="${sprite}.width = 50">sprite.width</a>
                <a href="#null" command="${sprite}.height = 50">sprite.height</a>
                <a href="#null" command="${sprite}.border_width">sprite.border_width</a>
                <a href="#null" command="${sprite}.border_color">sprite.border_color</a>

                <b>Circle sprites</b>
                <a href="#null" command="${sprite}.color = 'dark blue'">sprite.color</a>
                <a href="#null" command="${sprite}.radius = 100">sprite.radius</a>
                <a href="#null" command="${sprite}.border_width = 5">sprite.border_width</a>
                <a href="#null" command="${sprite}.border_color = 'red'">sprite.border_color</a>

                <b>Line sprites</b>
                <a href="#null" command="${sprite}.color = 'blue'">sprite.color</a>
                <a href="#null" command="${sprite}.length = 200">sprite.length</a>
                <a href="#null" command="${sprite}.angle = 45">sprite.angle</a>
                <a href="#null" command="${sprite}.x1 = -100">sprite.x1</a>
                <a href="#null" command="${sprite}.y1 = -100">sprite.y1</a>


            </div>

            <div>
                <h1>Mouse -</h1>
                <a href="#null" command="@${sprite}.when_clicked
async def do():
    ${sprite}.turn(30)">@sprite.when_clicked</a>
                <a href="#null" command="@play.when_mouse_clicked
async def do():
    ${sprite}.go_to(play.mouse)">@play.when_mouse_clicked</a>
                <a href="#null" command="@play.when_click_released
async def do():
    ${sprite}.go_to(play.mouse)">@play.when_click_released</a>
                <a href="#null" command="print(play.mouse.x)">play.mouse.x</a>
                <a href="#null" command="print(play.mouse.y)">play.mouse.y</a>
                <a href="#null" command="if play.mouse.is_clicked:
    print('mouse is clicked!')">play.mouse.is_clicked</a>
                <a href="#null" command="if play.mouse.is_touching(${sprite}):
    print('mouse is touching sprite!')">play.mouse.is_touching(sprite)</a>
            </div>

            <div>
                <h1>Keyboard -</h1>
                <a href="#null" command="@play.when_key_pressed('space')
async def do(key):
    print('space key pressed!')">@play.when_key_pressed()</a>
                <a href="#null" command="if play.key_is_pressed('up'):
    print('up key pressed!')">play.key_is_pressed()</a>
                <a href="#null" command="@play.when_any_key_pressed
async def do(key):
    print(key, 'key pressed')">@play.when_any_key_pressed</a>
                <a href="#null" command="@play.when_key_released('space')
async def do(key):
    print('space key released!')">@play.when_key_released</a>
                <a href="#null" command="@play.when_any_key_released
async def do(key):
    print(key, 'key released!')">@play.when_any_key_released</a>
            </div>

            <div>
                <h1>Physics -</h1>

                <a href="#null" command="${sprite}.start_physics(can_move=True, stable=False, x_speed=0, y_speed=0, obeys_gravity=True, bounciness=1, mass=10, friction=0.1)">sprite.start_physics()</a>
                <a href="#null" command="${sprite}.stop_physics()">sprite.stop_physics()</a>
                <a href="#null" command="${sprite}.physics.can_move = False">sprite.physics.can_move</a>
                <a href="#null" command="${sprite}.physics.stable = True">sprite.physics.stable</a>
                <a href="#null" command="${sprite}.physics.x_speed = 10">sprite.physics.x_speed</a>
                <a href="#null" command="${sprite}.physics.y_speed = 10">sprite.physics.y_speed</a>
                <a href="#null" command="${sprite}.physics.obeys_gravity = False">sprite.physics.obeys_gravity</a>
                <a href="#null" command="${sprite}.physics.bounciness = 0.2">sprite.physics.bounciness</a>
                <a href="#null" command="${sprite}.physics.mass = 50">sprite.physics.mass</a>
                <a href="#null" command="${sprite}.physics.friction = 1">sprite.physics.friction</a>
                <a href="#null" command="${sprite}.physics.pause()">sprite.physics.pause()</a>
                <a href="#null" command="${sprite}.physics.unpause()">sprite.physics.unpause()</a>
                <a href="#null" command="play.set_gravity(0)">play.set_gravity()</a>
            </div>

            <div>
                <h1>Other commands -</h1>
                <a href="#null" command="play.random_color()">play.random_color()</a>
                <a href="#null" command="play.random_number(lowest=0, highest=100)">play.random_number()</a>
                <a href="#null" command="${sprite}.go_to(play.random_position())">play.random_position()</a>
                <a href="#null" command="for sprite in play.all_sprites:
    print(sprite)">play.all_sprites</a>
                <a href="#null" command="for count in play.repeat(90):
    ${sprite}.turn(1)
    await play.animate()">play.animate()</a>
            </div>


        </div>

        <div style="text-align: right; margin: 0 10px; height: 99vh; max-width: 50%; line-height: 1.25;">
            <button style="margin: 10px;">start program</button>
            <div id="editor" style="text-align: left; border: 1px solid #ccc;"></div>
        </div>

        <div id="output" style="max-width: 30%; height: 99vh;">
            <h2>Program Output</h2>
            <pre style="width: 100%; overflow: auto; height: 100%; "></pre>
        </div>


        <script src="node_modules/codemirror/lib/codemirror.js"></script>
<script>
    const starting_template = `import play # this is the first line in your program


















play.start_program() # this is the last line in your program`;
</script>

<!--

    TODO:
        - keep indent level
        - paste command on current line if current line is blank and command doesn't start with newline (paste in sprite.x)
        - drag and drop text from parts bin (sarah did this by accident!)

        - control
        - sprite properties
        - keyboard
        - mouse
        - physics
        - screen
        - other

        - on start, open file that was previously saved

        - images to choose from
        - color picker
        - test installing / opening

IDE ideas:
    - add helpful comment about any code appearing below play.start_program() not running. I made this mistake and it was confusing. I also made the mistake of forgetting to include play.start_program() which made a window appear then disappear.
    - if pasting in event code (e.g. @play.when_key_pressed async def do(key)), make the indent level all the way to the left
    - if pasting in sprite code (e.g. hide()), find the last defined sprite before the cursor and call the method on that.
    - if command doesn't have visible effect (i.e. is_hidden), print it or create a conditional (if sprite.is_hidden: print("the sprite is hidden"))
    - if pasting in awaitable code (e.g. await play.timer(seconds=1.0)), somehow make sure it's in an async function
    - if possible, always paste full working example code that will do something visible

-->


<script type="text/javascript">
    const $ = require('jquery');
    const CodeMirror = require('codemirror');
    require("./node_modules/codemirror/mode/python/python.js") // syntax highlighting
    const React = require('react');
    const ReactDOM = require('react-dom');
    const fs = require('fs');
    const { spawn } = require('child_process');

    const play_commands = require('./commands') // category -> [list of commands {command, description}]

    main_editor = CodeMirror(document.querySelector('#editor'), {
        value: starting_template,
        mode: 'python',
        lineNumbers: true,
        lineWrapping: true,
        styleActiveLine: true,
        indentUnit: 4,
        theme: 'custom-play', // mdn-like
        matchBrackets: true,
        showCursorWhenSelecting: true,
        inputStyle: 'contenteditable',
        extraKeys: {
            Tab: (cm) => cm.execCommand("indentMore"),
            "Shift-Tab": (cm) => cm.execCommand("indentLess"),
        },
    });
    main_editor.getDoc().setCursor({line: 3})
    main_editor.on('change', function(cm) {
        save_file()
    })


    // show/hide collapsing sections
    $('#commands h1').on('click', function(evt) {
        var $header = $(evt.target)
        var $container = $header.parent()

        show_hide($container)
    });
    $('#commands #sprite-info h1').click() // start with this one collapsed since it's so long

    function show_hide($div) {
        var $header = $div.find('h1');
        var $links = $div.find('*').not('h1')

        if ($links.filter(':hidden').length > 0) {
           $links.show() 
           $header.text($header.text().replace('+', '-'))
        } else {
           $links.hide() 
           $header.text($header.text().replace('-', '+'))
        }
    }


    function get_last_sprite_name() {
        var doc = main_editor.getDoc();
        var cursor_line = doc.getCursor().line;

        var lines_till_cursor = doc.getValue().split('\n').slice(0, cursor_line)
        var last_sprite_line = lines_till_cursor.filter(function(line) {
            return line.includes('play.new_') || line.includes('.clone(')
        }).pop()

        if (!last_sprite_line) { return null }

        return last_sprite_line.split('=')[0].trim()
    }
    // clicking code to paste
    $('#commands a').on('click', function(evt) {
        evt.preventDefault();
        var $link = $(evt.target);
        var command = $link.attr('command');
        var doc = main_editor.getDoc();
        var cursor = doc.getCursor();
        cursor.ch = 1e10
        var sprite = get_last_sprite_name() || 'sprite';
        doc.replaceRange(`\n${command.replace(/\$\{sprite\}/g, sprite)}\n`, cursor);
        if ($('#start-program-option').is(':checked')) {
            start_program()
        }
    })



    // starting/stopping program

    function save_file() {
        fs.writeFileSync("program.py", main_editor.getValue())
    }

    var button = document.querySelector('button'); // start/stop button
    var output_element = document.querySelector('#output pre');
    var programs = [];

    function reset() {
        programs.shift()
        if (programs.length == 0) {
            button.innerText = 'start program';
        }
    }

    function stop_program() {
        console.log('program stopping')
        if (programs.length) {
            var program = programs[programs.length-1]
            program.stdin.end();
            program.stdout.end();
            program.kill()
        }
    }
    function start_program() {
        stop_program();

        output_element.innerText = '';
        save_file()

        var program = spawn('python3', ['-u', 'program.py'], {detached: true}) // -u runs in unbuffered mode
        program.on('exit', function() {
            reset()
        })
        program.stdout.on('data', (data) => {
            output_element.scrollTop = 1e6;
            output_element.innerText += data.toString();
            // console.log('stdout', data.toString())
        })
        program.stderr.on('data', (error_data) => {
            output_element.scrollTop = 1e6;
            output_element.innerText += error_data.toString();
            // console.log('error', error_data.toString())
        })
        programs.push(program)

        button.innerText = 'stop program'
    }
    button.addEventListener('click', function (e) {
        if (programs.length) {
            stop_program()
        } else {
            start_program()
        }
    }, false);


</script>
    </body>
</html>